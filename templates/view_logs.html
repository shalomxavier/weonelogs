<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Logs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>View Logs</h1>
            <div class="breadcrumb">
                <a href="{{ url_for('landing') }}">Home</a> <span>/</span>
                <a href="{{ url_for('logs') }}">Logs</a> <span>/</span> View Logs
            </div>
        </header>
        <main>
            <div class="logs-header">
                <h2>
                    Submitted Logs ({{ logs|length }} total)
                    <span class="weekly-total">• Weekly Terminal Success: {{ weekly_terminal_success }}</span>
                </h2>
                <a href="{{ url_for('add_log_form') }}" class="btn btn-primary">Add New Log</a>
            </div>

            {% if campaign_warnings %}
                <section class="campaign-warnings" aria-live="polite">
                    <div class="warning-header">
                        <h3>Campaign Coverage Alerts</h3>
                        <p>Each campaign must have logs for every location. Missing locations are listed below.</p>
                    </div>
                    <ul class="warning-list">
                        {% for warning in campaign_warnings %}
                            <li class="warning-item">
                                <div class="warning-campaign">
                                    <strong>Campaign {{ warning.campaign }}</strong>
                                </div>
                                <div class="warning-missing">
                                    Missing locations:
                                    <span class="missing-list">{{ warning.missing_locations | join(', ') }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </section>
            {% endif %}

            <div class="filter-bar">
                <form method="GET" action="{{ url_for('view_logs') }}" class="filter-form">
                    <div class="filter-field">
                        <label for="location-filter">Filter by Location</label>
                        <div class="select-wrapper">
                            <select id="location-filter" name="location" onchange="this.form.submit()" aria-label="Filter logs by location">
                                <option value="">All Locations</option>
                                {% for location in unique_locations %}
                                    <option value="{{ location }}" {% if selected_location and location.lower() == selected_location.lower() %}selected{% endif %}>
                                        {{ location }}
                                    </option>
                                {% endfor %}
                            </select>
                            <span class="select-chevron">⌄</span>
                        </div>
                    </div>
                    <div class="filter-field">
                        <label for="campaign-filter">Filter by Campaign</label>
                        <div class="select-wrapper">
                            <select id="campaign-filter" name="campaign" onchange="this.form.submit()" aria-label="Filter logs by campaign">
                                <option value="">All Campaigns</option>
                                {% for campaign in unique_campaigns %}
                                    <option value="{{ campaign }}" {% if selected_campaign == campaign %}selected{% endif %}>{{ campaign }}</option>
                                {% endfor %}
                            </select>
                            <span class="select-chevron">⌄</span>
                        </div>
                    </div>
                    <div class="filter-field">
                        <label for="date-filter">Filter by Date</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="date-filter" name="log_date" value="{{ selected_date }}" onchange="this.form.submit()" aria-label="Filter logs by date" class="date-input">
                        </div>
                    </div>
                    <div class="filter-field">
                        <label for="abnormal-filter">Filter by Status</label>
                        <div class="select-wrapper">
                            <select id="abnormal-filter" name="abnormal" onchange="this.form.submit()" aria-label="Filter logs by status">
                                <option value="">All Entries</option>
                                <option value="abnormal" {% if selected_abnormal == 'abnormal' %}selected{% endif %}>Abnormal Only</option>
                                <option value="normal" {% if selected_abnormal == 'normal' %}selected{% endif %}>Normal Only</option>
                            </select>
                            <span class="select-chevron">⌄</span>
                        </div>
                    </div>
                    <noscript>
                        <button type="submit" class="btn btn-secondary">Apply</button>
                    </noscript>
                </form>
            </div>
            
            {% if logs %}
                <div class="logs-container">
                    {% for log in logs %}
                        <div class="log-entry {% if log.abnormal %}log-entry--abnormal{% endif %}">
                            <div class="log-header">
                                <div>
                                    <h3>Log #{{ log.id }} - {{ log.location }}</h3>
                                    <p class="log-date">{{ log.log_date or 'No date set' }}</p>
                                </div>
                                <div class="log-header-meta">
                                    {% if log.abnormal %}
                                        <span class="abnormal-pill">Abnormal</span>
                                    {% endif %}
                                    <span class="timestamp">{{ log.log_date or log.timestamp }}</span>
                                </div>
                            </div>
                             
                            <div class="log-content">
                                <div class="log-actions">
                                    <a href="{{ url_for('edit_log', log_id=log.id) }}" class="btn btn-secondary btn-small">Edit</a>
                                    <form method="POST" action="{{ url_for('delete_log', log_id=log.id) }}" onsubmit="return confirm('Delete this log entry?');">
                                        <button type="submit" class="btn btn-danger btn-small">Delete</button>
                                    </form>
                                </div>
                                <div class="log-field">
                                    <strong>Campaign Number:</strong> {{ log.campaign_number }}
                                </div>
                                {% if log.terminal_success is not none %}
                                    <div class="log-field">
                                        <strong>Terminal Success:</strong> {{ log.terminal_success }}
                                    </div>
                                {% endif %}
                                
                                {% if log.errors %}
                                    <div class="log-field">
                                        <strong>Errors:</strong>
                                        <p class="errors-text">{{ log.errors }}</p>
                                    </div>
                                {% endif %}
                                
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No logs found</h3>
                    <p>Start by adding your first log entry.</p>
                    <a href="{{ url_for('add_log_form') }}" class="btn btn-primary">Add First Log</a>
                </div>
            {% endif %}
        </main>
        
        <footer>
            <p>&copy; 2026 Log Management System</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const filterForm = document.querySelector('.filter-form');
            if (!filterForm) return;

            const storageKey = 'logFilters';
            const fieldNames = ['location', 'campaign', 'log_date', 'abnormal'];

            const savedFilters = JSON.parse(localStorage.getItem(storageKey) || '{}');
            let shouldSubmit = false;

            fieldNames.forEach(function (name) {
                const field = filterForm.querySelector(`[name="${name}"]`);
                if (!field || !(name in savedFilters)) {
                    return;
                }
                if (field.value !== savedFilters[name]) {
                    field.value = savedFilters[name];
                    shouldSubmit = true;
                }
            });

            if (shouldSubmit) {
                filterForm.submit();
            }

            const persistFilters = function () {
                const current = {};
                fieldNames.forEach(function (name) {
                    const field = filterForm.querySelector(`[name="${name}"]`);
                    if (field) {
                        current[name] = field.value || '';
                    }
                });
                localStorage.setItem(storageKey, JSON.stringify(current));
            };

            filterForm.addEventListener('change', persistFilters);
        });
    </script>
</body>
</html>
