<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Logs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>View Logs</h1>
            <div class="breadcrumb">
                <a href="{{ url_for('landing') }}">Home</a> <span>/</span>
                <a href="{{ url_for('logs') }}">Logs</a> <span>/</span> View Logs
            </div>
        </header>
        <main>
            <div class="logs-header">
                <h2>
                    Submitted Logs ({{ logs|length }} total)
                    <span class="weekly-total">• Weekly Terminal Success: {{ weekly_terminal_success }}</span>
                </h2>
                <a href="{{ url_for('add_log_form') }}" class="btn btn-primary">Add New Log</a>
            </div>

            {% if campaign_warnings %}
                <section class="campaign-warnings" aria-live="polite">
                    <div class="warning-header">
                        <h3>Campaign Coverage Alerts</h3>
                        <p>Each campaign must have logs for every location. Missing locations are listed below.</p>
                    </div>
                    <ul class="warning-list">
                        {% for warning in campaign_warnings %}
                            <li class="warning-item">
                                <div class="warning-campaign">
                                    <strong>Campaign {{ warning.campaign }}</strong>
                                </div>
                                <div class="warning-missing">
                                    Missing locations:
                                    <span class="missing-list">{{ warning.missing_locations | join(', ') }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </section>
            {% endif %}

            <div class="filter-bar">
                <form method="GET" action="{{ url_for('view_logs') }}" class="filter-form">
                    <div class="filter-field">
                        <label for="location-filter">Filter by Location</label>
                        <details class="multi-dropdown" data-filter-group="location">
                            <summary class="multi-dropdown__trigger" id="location-filter">
                                <span>
                                    {% if selected_locations %}
                                        {{ selected_locations | length }} selected
                                    {% else %}
                                        All Locations
                                    {% endif %}
                                </span>
                                <span class="select-chevron">⌄</span>
                            </summary>
                            <div class="multi-dropdown__menu" aria-label="Filter logs by locations">
                                <div class="multi-dropdown__controls">
                                    <button type="button" class="multi-dropdown__control" data-control="select-all">Select All</button>
                                    <button type="button" class="multi-dropdown__control" data-control="clear-all">Clear All</button>
                                </div>
                                {% for location in unique_locations %}
                                    <label class="multi-dropdown__option">
                                        <input type="checkbox" name="location" value="{{ location }}" {% if location in selected_locations %}checked{% endif %}>
                                        <span>{{ location }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </details>
                    </div>
                    <div class="filter-field">
                        <label for="campaign-filter">Filter by Campaign</label>
                        <details class="multi-dropdown" data-filter-group="campaign">
                            <summary class="multi-dropdown__trigger" id="campaign-filter">
                                <span>
                                    {% if selected_campaigns %}
                                        {{ selected_campaigns | length }} selected
                                    {% else %}
                                        All Campaigns
                                    {% endif %}
                                </span>
                                <span class="select-chevron">⌄</span>
                            </summary>
                            <div class="multi-dropdown__menu" aria-label="Filter logs by campaigns">
                                <div class="multi-dropdown__controls">
                                    <button type="button" class="multi-dropdown__control" data-control="select-all">Select All</button>
                                    <button type="button" class="multi-dropdown__control" data-control="clear-all">Clear All</button>
                                </div>
                                {% for campaign in unique_campaigns %}
                                    <label class="multi-dropdown__option">
                                        <input type="checkbox" name="campaign" value="{{ campaign }}" {% if campaign in selected_campaigns %}checked{% endif %}>
                                        <span>{{ campaign }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </details>
                    </div>
                    <div class="filter-field">
                        <label for="date-filter">Filter by Date</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="date-filter" name="log_date" value="{{ selected_date }}" onchange="this.form.submit()" aria-label="Filter logs by date" class="date-input">
                        </div>
                    </div>
                    <div class="filter-field">
                        <label for="abnormal-filter">Filter by Status</label>
                        <div class="select-wrapper">
                            <select id="abnormal-filter" name="abnormal" onchange="this.form.submit()" aria-label="Filter logs by status">
                                <option value="">All Entries</option>
                                <option value="abnormal" {% if selected_abnormal == 'abnormal' %}selected{% endif %}>Abnormal Only</option>
                                <option value="normal" {% if selected_abnormal == 'normal' %}selected{% endif %}>Normal Only</option>
                            </select>
                            <span class="select-chevron">⌄</span>
                        </div>
                    </div>
                    <noscript>
                        <button type="submit" class="btn btn-secondary">Apply</button>
                    </noscript>
                </form>
            </div>
            
            {% if logs %}
                <div class="logs-container">
                    {% for log in logs %}
                        <div class="log-entry {% if log.abnormal %}log-entry--abnormal{% endif %}">
                            <div class="log-header">
                                <div>
                                    <h3>{{ log.location }}</h3>
                                    <p class="log-date">{{ log.log_date or 'No date set' }}</p>
                                </div>
                                <div class="log-header-meta">
                                    <span class="timestamp">{{ log.log_date or log.timestamp }}</span>
                                </div>
                            </div>
                             
                            <div class="log-content">
                                <div class="log-actions">
                                    <a href="{{ url_for('edit_log', log_id=log.id) }}" class="btn btn-secondary icon-button" aria-label="Edit this log">
                                        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false">
                                            <path d="M3 14.25V17h2.75L15.81 6.94l-2.75-2.75L3 14.25zm13.71-7.04a1 1 0 0 0 0-1.41l-1.51-1.51a1 1 0 0 0-1.41 0l-1.18 1.18 2.75 2.75 1.35-1.01z"/>
                                        </svg>
                                        <span class="sr-only">Edit this log</span>
                                    </a>
                                    <form method="POST" action="{{ url_for('delete_log', log_id=log.id) }}" onsubmit="return confirm('Delete this log entry?');">
                                        <button type="submit" class="btn btn-danger icon-button" aria-label="Delete this log">
                                            <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false">
                                                <path d="M6 7h1v9H6V7zm3 0h1v9H9V7zm3 0h1v9h-1V7z"/>
                                                <path d="M3 5h14v1H3V5zm2.5 0V4h9v1h1V4a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1v1h1zM15 6v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h10z"/>
                                            </svg>
                                            <span class="sr-only">Delete this log</span>
                                        </button>
                                    </form>
                                </div>
                                <div class="log-field">
                                    <strong>Campaign Number:</strong> {{ log.campaign_number }}
                                </div>
                                {% if log.terminal_success is not none %}
                                    <div class="log-field">
                                        <strong>Terminal Success:</strong> {{ log.terminal_success }}
                                    </div>
                                {% endif %}
                                
                                {% if log.errors %}
                                    <div class="log-field log-field--errors">
                                        <p class="errors-text">{{ log.errors }}</p>
                                    </div>
                                {% endif %}
                                
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No logs found</h3>
                    <p>Start by adding your first log entry.</p>
                    <a href="{{ url_for('add_log_form') }}" class="btn btn-primary">Add First Log</a>
                </div>
            {% endif %}
        </main>
        
        <footer>
            <p>&copy; 2026 Log Management System</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.location.search) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            document.querySelectorAll('.multi-dropdown').forEach(function (dropdown) {
                const form = dropdown.closest('form');
                let isDirty = false;
                const markDirty = () => { isDirty = true; };

                dropdown.querySelectorAll('input[type="checkbox"]').forEach(function (checkbox) {
                    checkbox.addEventListener('change', markDirty);
                });

                dropdown.querySelectorAll('.multi-dropdown__control').forEach(function (button) {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();
                        const action = button.dataset.control;
                        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                        if (action === 'select-all') {
                            checkboxes.forEach(cb => { if (!cb.checked) { cb.checked = true; markDirty(); } });
                        } else if (action === 'clear-all') {
                            checkboxes.forEach(cb => { if (cb.checked) { cb.checked = false; markDirty(); } });
                        }
                    });
                });

                dropdown.addEventListener('toggle', function () {
                    if (!dropdown.open && isDirty && form) {
                        isDirty = false;
                        form.submit();
                    }
                });
            });

            document.addEventListener('click', function (event) {
                document.querySelectorAll('.multi-dropdown[open]').forEach(function (dropdown) {
                    if (!dropdown.contains(event.target)) {
                        dropdown.open = false;
                    }
                });
            });
        });
    </script>
</body>
</html>
